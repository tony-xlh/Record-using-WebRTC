<!DOCTYPE html>
<html lang="en">
  <head>
    <title>RecordRTC Simple Demos</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@9.6.31/dist/dbr.js"></script>
    <style>
      video {
        max-width: 100%;
      }
    </style>
  </head>

  <body>
    <select id="select-camera"></select>
    <button id="btn-start-recording">Start Recording</button>
    <button id="btn-stop-recording" disabled>Stop Recording</button>
    <hr>
    <video controls autoplay playsinline></video>

    <script src="RecordRTC.js"></script>
    <script>
    var video = document.querySelector('video');
    var cameraSelect = document.getElementById("select-camera");
    var devices;
    var hasMicrophone = true;
    var scanner;
    window.onload = function(){
      listDevices();
      initDBR();
    }

    async function initDBR(){
      Dynamsoft.DBR.BarcodeScanner.license = 'DLS2eyJoYW5kc2hha2VDb2RlIjoiMjAwMDAxLTE2NDk4Mjk3OTI2MzUiLCJvcmdhbml6YXRpb25JRCI6IjIwMDAwMSIsInNlc3Npb25QYXNzd29yZCI6IndTcGR6Vm05WDJrcEQ5YUoifQ=='; //one-day public trial
      scanner = await Dynamsoft.DBR.BarcodeScanner.createInstance();
    }

    async function listDevices(){
      devices = await getCameraDevices()
      for (let index = 0; index < devices.length; index++) {
        const device = devices[index];
        cameraSelect.appendChild(new Option(device.label,device.deviceId));
      }
    }

    async function getCameraDevices(){
      await askForPermissions();
      var devices = await navigator.mediaDevices.enumerateDevices();
      var cameraDevices = [];
      for (var i=0;i<devices.length;i++){
        var device = devices[i];
        if (device.kind == 'videoinput'){
          cameraDevices.push(device);
        }
      }
      return cameraDevices;
    }

    async function askForPermissions(){
      var stream;
      try {
        var constraints = {video: true, audio: true}; //ask for camera and microphone permission
        stream = await navigator.mediaDevices.getUserMedia(constraints);  
      } catch (error) {
        console.log(error);
        var constraints = {video: true, audio: false}; //ask for camera permission only
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        hasMicrophone = false;
      }
      closeStream(stream);
    }

    function closeStream(stream){
      try{
        if (stream){
          stream.getTracks().forEach(track => track.stop());
        }
      } catch (e){
        alert(e.message);
      }
    }

    function captureCamera(callback) {
      var constraints = {
        audio:false,
        video:true
      }
      if (cameraSelect.selectedOptions[0]) {
        var device = devices[cameraSelect.selectedIndex];
        var deviceID = device.deviceId;
        console.log(deviceID);
        constraints = {
          video: {deviceId: deviceID},
          audio: hasMicrophone
        }
      }
      navigator.mediaDevices.getUserMedia(constraints).then(function(camera) {
        //video.srcObject = camera;
        callback(camera);
      }).catch(function(error) {
        alert('Unable to capture your camera. Please check console logs.');
        console.error(error);
      });
    }

    function stopRecordingCallback() {
      video.src = video.srcObject = null;
      video.muted = false;
      video.volume = 1;
      video.src = URL.createObjectURL(recorder.getBlob());
      
      recorder.camera.stop();
      recorder.destroy();
      recorder = null;
    }

    var recorder; // globally accessible

    document.getElementById('btn-start-recording').onclick = function() {
      this.disabled = true;
      captureCamera(function(camera) {
      video.muted = true;
      video.volume = 0;
      video.srcObject = camera;

      recorder = RecordRTC(camera, {
        type: 'video'
      });

      recorder.startRecording();

      // release camera on stopRecording
      recorder.camera = camera;

      document.getElementById('btn-stop-recording').disabled = false;
      });
    };

    document.getElementById('btn-stop-recording').onclick = function() {
      this.disabled = true;
      recorder.stopRecording(stopRecordingCallback);
    };
    </script>
  </body>
</html>